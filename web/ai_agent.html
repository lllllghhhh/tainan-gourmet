<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å°å—ç¾é£Ÿ AI Agent</title>

  <!-- å…±ç”¨æ¨£å¼ -->
  <link rel="stylesheet" href="css/style.css">

  <style>
    .agent-box {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 16px;
      background: #fff;
    }
    .agent-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      align-items: center;
    }
    textarea {
      width: 100%;
      height: 140px;
      padding: 10px;
    }
    button {
      padding: 10px 16px;
      cursor: pointer;
    }
    button[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }
    pre {
      white-space: pre-wrap;
      background: #f7f7f7;
      padding: 12px;
      border-radius: 8px;
    }
    select, input {
      padding: 8px;
      min-width: 220px;
    }
    .hint {
      color: #666;
      font-size: 14px;
      margin: 6px 0 14px;
    }
  </style>
</head>

<body>
  <!-- ===== Headerï¼ˆæ²¿ç”¨ä½ åŸæœ¬ç¶²ç«™ï¼‰ ===== -->
  <header class="site-header">
    <div class="header-spacer"></div>
    <div class="header-inner">
      <div class="brand">
        <img src="image/IIM_logo.png" class="logo-img" alt="IIMå¥½é£Ÿåœ¨ Logo">
      </div>

      <nav class="main-nav" aria-label="ä¸»é¸å–®">
        <a href="index.html">é¦–é </a>

        <div class="dropdown">
          <button class="dropbtn" type="button">é£Ÿç‰©ç¨®é¡ â–¼</button>
          <div class="dropdown-content">
            <a href="tainan.html">å°å—ç‰¹è‰²ç¾é£Ÿ</a>
            <a href="ramen.html">æ‹‰éºµ</a>
            <a href="japaness.html">ä¸¼é£¯ & æ—¥å¼æ–™ç†</a>
            <a href="noodles.html">é‹ç‡’æ„éºµ</a>
            <a href="beef_soup.html">ç‰›è‚‰æ¹¯å°ˆå€</a>
            <a href="midnight.html">å®µå¤œåº—</a>
          </div>
        </div>

        <a href="spin.html">ç¾é£Ÿæ‹‰éœ¸æ©Ÿ</a>
        <a href="diet.html">ç½ªæƒ¡è¨ˆç®—æ©Ÿ</a>
        <a href="ai_agent.html" class="active">AI Agent</a>
      </nav>
    </div>
  </header>

  <div class="header-spacer"></div>

  <!-- ===== ä¸»å…§å®¹ ===== -->
  <main class="content">
    <h2>ğŸœ å°å—ç¾é£Ÿæ¨è–¦ AI Agent</h2>
    <p class="hint">
      æœ¬é æœƒè‡ªå‹•è¼‰å…¥å¯ç”¨æ¨¡å‹ä¸¦æä¾›ä¸‹æ‹‰é¸å–®ï¼›é€å‡ºå¾Œæœƒé€é <code>/proxy</code> å‘¼å«ä½ çš„æ¨¡å‹æœå‹™ã€‚
    </p>

    <div class="agent-box">
      <div class="agent-row">
        <label for="model">æ¨¡å‹ï¼š</label>
        <select id="model" aria-label="æ¨¡å‹">
          <option value="gpt-oss:20b">gpt-oss:20b</option>
        </select>
        <span id="status"></span>
      </div>

      <h3>ä½ çš„éœ€æ±‚</h3>
      <textarea id="prompt" placeholder="ä¾‹å¦‚ï¼šæˆå¤§é™„è¿‘çš„å®µå¤œï¼Œä¸è¦å¤ªè²´ã€æƒ³åƒç‰›è‚‰æ¹¯æˆ–é‹ç‡’æ„éºµ"></textarea>

      <div class="agent-row">
        <button id="send" type="button">é€å‡ºæ¨è–¦</button>
      </div>

      <h3>AI æ¨è–¦çµæœ</h3>
      <pre id="out"></pre>
    </div>
  </main>

  <script src="js/agent.js"></script>
  <script>
    const statusEl = document.getElementById("status");
    const sendBtn = document.getElementById("send");
    const promptEl = document.getElementById("prompt");

    let isSending = false;

    async function loadModelsIntoSelect() {
      const modelSel = document.getElementById("model");
      statusEl.textContent = "è¼‰å…¥æ¨¡å‹ä¸­...";

      try {
        const data = await agentListModels();
        const names = (data.models || []).map(m => m.name).filter(Boolean);

        if (!names.length) {
          statusEl.textContent = "ï¼ˆæœªå–å¾—æ¨¡å‹æ¸…å–®ï¼Œä½¿ç”¨é è¨­æ¨¡å‹ï¼‰";
          return;
        }

        modelSel.innerHTML = "";
        for (const name of names) {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          modelSel.appendChild(opt);
        }

        const preferred = "gpt-oss:20b";
        modelSel.value = names.includes(preferred) ? preferred : names[0];

        statusEl.textContent = "å®Œæˆ";
      } catch (e) {
        statusEl.textContent = "ï¼ˆæ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­æ¨¡å‹ï¼‰";
      }
    }

    function setSendingState(sending) {
      isSending = sending;
      sendBtn.disabled = sending;
      if (sending) {
        sendBtn.textContent = "é€å‡ºä¸­...";
      } else {
        sendBtn.textContent = "é€å‡ºæ¨è–¦";
      }
    }

    async function handleSend() {
      if (isSending) return; // âœ… é˜²æ­¢é‡è¤‡é€å‡º

      const model = document.getElementById("model").value;
      const text = promptEl.value.trim();
      if (!text) return;

      const finalPrompt =
        `ä½ æ˜¯ã€Œå°å—ç¾é£Ÿæ¨è–¦ã€AIï¼Œè«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚\n` +
        `è«‹è¼¸å‡ºï¼š\n` +
        `1) æ¨è–¦ 3-5 é–“åº—ï¼ˆæ¯é–“ï¼šåº—å/é¡å‹/å¤§æ¦‚åƒ¹ä½/æ¨è–¦åŸå› /é©åˆæ™‚æ®µ/å¤§æ¦‚å€åŸŸï¼‰\n` +
        `2) è‹¥è³‡è¨Šä¸è¶³ï¼Œå…ˆå•æˆ‘ 1-2 å€‹é—œéµå•é¡Œå†æ¨è–¦ã€‚\n\n` +
        `ä½¿ç”¨è€…éœ€æ±‚ï¼š${text}\n`;

      statusEl.textContent = "è«‹æ±‚ä¸­...";
      document.getElementById("out").textContent = "";

      setSendingState(true);
      try {
        const data = await agentSend(finalPrompt, model);
        document.getElementById("out").textContent =
          data.message?.content ?? JSON.stringify(data, null, 2);
        statusEl.textContent = "å®Œæˆ";
      } catch (e) {
        statusEl.textContent = "å¤±æ•—ï¼ˆç¢ºèª server.py/proxy æ˜¯å¦æœ‰è·‘ï¼‰";
        document.getElementById("out").textContent = String(e);
      } finally {
        setSendingState(false);
      }
    }

    // âœ… æŒ‰éˆ•é€å‡ºï¼ˆæœƒé–ä½é¿å…é€£é»ï¼‰
    sendBtn.addEventListener("click", handleSend);

    // âœ… é˜²æ­¢ Enter é€£æŒ‰é€ æˆé€£çºŒé€å‡ºï¼šEnter = é€å‡ºï¼›Shift+Enter = æ›è¡Œ
    promptEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // é€²é é¢è‡ªå‹•è¼‰å…¥æ¨¡å‹
    loadModelsIntoSelect();
  </script>
</body>
</html>
