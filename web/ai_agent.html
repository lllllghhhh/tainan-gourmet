<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å°å—ç¾é£Ÿ AI Agent</title>

  <!-- å…±ç”¨æ¨£å¼ -->
  <link rel="stylesheet" href="css/style.css">

  <style>
    .agent-box {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 16px;
      background: #fff;
    }
    .agent-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      align-items: center;
    }
    textarea {
      width: 100%;
      height: 140px;
      padding: 10px;
    }
    button {
      padding: 10px 16px;
      cursor: pointer;
    }
    button[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }
    pre {
      white-space: pre-wrap;
      background: #f7f7f7;
      padding: 12px;
      border-radius: 8px;
    }
    select {
      padding: 8px;
      min-width: 220px;
    }
    .hint {
      color: #666;
      font-size: 14px;
      margin: 6px 0 14px;
    }
  </style>
</head>

<body>
  <!-- ===== Headerï¼ˆæ²¿ç”¨ä½ åŸæœ¬ç¶²ç«™ï¼‰ ===== -->
  <header class="site-header">
    <div class="header-spacer"></div>
    <div class="header-inner">
      <div class="brand">
        <img src="image/IIM_logo.png" class="logo-img" alt="IIMå¥½é£Ÿåœ¨ Logo">
      </div>

      <nav class="main-nav" aria-label="ä¸»é¸å–®">
        <a href="index.html">é¦–é </a>

        <div class="dropdown">
          <button class="dropbtn" type="button">é£Ÿç‰©ç¨®é¡ â–¼</button>
          <div class="dropdown-content">
            <a href="tainan.html">å°å—ç‰¹è‰²ç¾é£Ÿ</a>
            <a href="ramen.html">æ‹‰éºµ</a>
            <a href="japaness.html">ä¸¼é£¯ & æ—¥å¼æ–™ç†</a>
            <a href="noodles.html">é‹ç‡’æ„éºµ</a>
            <a href="beef_soup.html">ç‰›è‚‰æ¹¯å°ˆå€</a>
            <a href="midnight.html">å®µå¤œåº—</a>
          </div>
        </div>

        <a href="spin.html">ç¾é£Ÿæ‹‰éœ¸æ©Ÿ</a>
        <a href="diet.html">ç½ªæƒ¡è¨ˆç®—æ©Ÿ</a>
        <a href="ai_agent.html" class="active">AI Agent</a>
      </nav>
    </div>
  </header>

  <div class="header-spacer"></div>

  <!-- ===== ä¸»å…§å®¹ ===== -->
  <main class="content">
    <h2>ğŸœ å°å—ç¾é£Ÿæ¨è–¦ AI Agent</h2>
    <p class="hint">
      è«‹ç›´æ¥æè¿°ä½ æƒ³åƒçš„å…§å®¹ï¼ˆåœ°é»ã€æ™‚æ®µã€åƒ¹æ ¼ã€ç¨®é¡éƒ½å¯è‡ªç”±æè¿°ï¼‰ã€‚
      AI æœƒæ¨è–¦é©åˆçš„å°å—ç¾é£Ÿä¸¦é™„ä¸Šã€Œå¯å¯¦éš›å‰å¾€çš„åœ°å€è³‡è¨Šã€ã€‚
      
    </p>

    <div class="agent-box">
      <div class="agent-row">
        <label for="model">æ¨¡å‹ï¼š</label>
        <select id="model" aria-label="æ¨¡å‹">
          <option value="gpt-oss:20b">gpt-oss:20b</option>
        </select>
        <span id="status"></span>
      </div>

      <h3>ä½ çš„éœ€æ±‚</h3>
      <textarea
        id="prompt"
        placeholder="ä¾‹å¦‚ï¼šæˆå¤§é™„è¿‘å®µå¤œï¼Œé ç®— 150 å·¦å³ï¼Œæƒ³åƒç‰›è‚‰æ¹¯æˆ–é‹ç‡’æ„éºµ"></textarea>

      <div class="agent-row">
        <button id="send" type="button">é€å‡ºæ¨è–¦</button>
      </div>

      <h3>AI æ¨è–¦çµæœ</h3>
      <pre id="out"></pre>
    </div>
  </main>

  <!-- å…±ç”¨ä»£ç†å‘¼å« -->
  <script src="js/agent.js"></script>

  <script>
    const statusEl = document.getElementById("status");
    const sendBtn = document.getElementById("send");
    const promptEl = document.getElementById("prompt");
    let isSending = false;

    async function loadModelsIntoSelect() {
      const modelSel = document.getElementById("model");
      statusEl.textContent = "è¼‰å…¥æ¨¡å‹ä¸­...";

      try {
        const data = await agentListModels();
        const names = (data.models || []).map(m => m.name).filter(Boolean);

        // æ²’æŠ“åˆ°å°±ä¿ç•™é è¨­
        if (!names.length) {
          statusEl.textContent = "ï¼ˆä½¿ç”¨é è¨­æ¨¡å‹ï¼‰";
          return;
        }

        modelSel.innerHTML = "";
        for (const name of names) {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          modelSel.appendChild(opt);
        }

        modelSel.value = names.includes("gpt-oss:20b") ? "gpt-oss:20b" : names[0];
        statusEl.textContent = "å®Œæˆ";
      } catch {
        statusEl.textContent = "ï¼ˆæ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­æ¨¡å‹ï¼‰";
      }
    }

    function setSendingState(sending) {
      isSending = sending;
      sendBtn.disabled = sending;
      sendBtn.textContent = sending ? "é€å‡ºä¸­..." : "é€å‡ºæ¨è–¦";
    }

    async function handleSend() {
      if (isSending) return; // é˜²æ­¢é‡è¤‡é€å‡º

      const text = promptEl.value.trim();
      if (!text) return;

      const model = document.getElementById("model").value;

      const finalPrompt =
        `ä½ æ˜¯ã€Œå°å—ç¾é£Ÿæ¨è–¦ã€AI Agentï¼Œè«‹ä¸€å¾‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚\n\n` +
        `è«‹è¼¸å‡º 3â€“5 é–“æ¨è–¦ï¼Œä¸¦ä½¿ç”¨å›ºå®šæ ¼å¼ï¼ˆæ¯é–“ä¸€æ®µï¼‰ï¼š\n` +
        `ã€åº—åã€‘\n` +
        `ã€é¡å‹ã€‘\n` +
        `ã€å¤§æ¦‚åƒ¹ä½ã€‘\n` +
        `ã€æ¨è–¦åŸå› ã€‘\n` +
        `ã€é©åˆæ™‚æ®µã€‘\n` +
        `ã€å¤§æ¦‚å€åŸŸã€‘(ä¾‹å¦‚ï¼šæˆå¤§å‘¨é‚Š/ä¸­è¥¿å€/å®‰å¹³/æ±å€/æŸå•†åœˆ)\n` +
        `ã€åœ°å€ã€‘\n` +
        `- è‹¥èƒ½ç¢ºå®šé–€ç‰Œæ‰å¯«é–€ç‰Œ\n` +
        `- è‹¥ä¸ç¢ºå®šé–€ç‰Œï¼šåªå¯«åˆ°è·¯å/å•†åœˆ/åœ°æ¨™ï¼Œä¸¦æ¨™è¨»ã€Œé–€ç‰Œä¸ç¢ºå®šã€\n` +
        `ã€Google Maps æœå°‹ã€‘è«‹çµ¦ä¸€å€‹å¯ç›´æ¥æœå°‹çš„é—œéµå­—ï¼ˆä¾‹å¦‚ï¼šåº—å å°å— ä¸­è¥¿å€ï¼‰\n\n` +
        `è‹¥è³‡è¨Šä¸è¶³ï¼Œå…ˆè©¢å• 1â€“2 å€‹é—œéµå•é¡Œå†æ¨è–¦ã€‚\n\n` +
        `ä½¿ç”¨è€…éœ€æ±‚ï¼š${text}\n`;

      statusEl.textContent = "è«‹æ±‚ä¸­...";
      document.getElementById("out").textContent = "";
      setSendingState(true);

      try {
        const data = await agentSend(finalPrompt, model);
        document.getElementById("out").textContent =
          data.message?.content ?? JSON.stringify(data, null, 2);
        statusEl.textContent = "å®Œæˆ";
      } catch (e) {
        statusEl.textContent = "å¤±æ•—ï¼ˆè«‹ç¢ºèª server.py/proxy æ˜¯å¦æœ‰å•Ÿå‹•ï¼‰";
        document.getElementById("out").textContent = String(e);
      } finally {
        setSendingState(false);
      }
    }

    // æŒ‰éˆ•é€å‡ºï¼ˆæœƒé–ä½é¿å…é€£é»ï¼‰
    sendBtn.addEventListener("click", handleSend);

    // Enter = é€å‡ºï¼›Shift+Enter = æ›è¡Œ
    promptEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // é€²é é¢è‡ªå‹•è¼‰å…¥æ¨¡å‹
    loadModelsIntoSelect();
  </script>
</body>
</html>
